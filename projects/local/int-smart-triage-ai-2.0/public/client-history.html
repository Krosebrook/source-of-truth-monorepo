<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Client History - INT Smart Triage AI 2.0</title>
    <link rel="stylesheet" href="/public/theme.css" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu,
          Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      /* Navigation Header */
      .nav-header {
        background: #2c3e50;
        color: white;
        padding: 15px 30px;
        border-radius: 10px 10px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0;
      }

      .nav-brand {
        font-size: 1.5em;
        font-weight: 700;
        color: white;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .nav-brand:hover {
        opacity: 0.9;
      }

      .nav-menu {
        display: flex;
        gap: 5px;
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .nav-link {
        color: white;
        text-decoration: none;
        padding: 10px 20px;
        border-radius: 5px;
        transition: background 0.3s;
        font-weight: 500;
      }

      .nav-link:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .nav-link.active {
        background: rgba(255, 255, 255, 0.2);
        font-weight: 600;
      }

      .nav-toggle {
        display: none;
        background: none;
        border: none;
        color: white;
        font-size: 1.5em;
        cursor: pointer;
      }

      @media (max-width: 768px) {
        .nav-header {
          flex-wrap: wrap;
        }

        .nav-toggle {
          display: block;
        }

        .nav-menu {
          display: none;
          width: 100%;
          flex-direction: column;
          margin-top: 15px;
          gap: 0;
        }

        .nav-menu.active {
          display: flex;
        }

        .nav-link {
          padding: 15px;
          border-radius: 0;
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
      }

      .header {
        background: white;
        padding: 20px 30px;
        border-radius: 0 0 10px 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        color: #667eea;
        font-size: 24px;
      }

      .header-actions {
        display: flex;
        gap: 10px;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5568d3;
      }

      .btn-secondary {
        background: #e0e7ff;
        color: #667eea;
      }

      .btn-secondary:hover {
        background: #c7d2fe;
      }

      .search-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .search-form {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr auto;
        gap: 10px;
        align-items: end;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group label {
        font-size: 12px;
        font-weight: 600;
        color: #666;
        margin-bottom: 5px;
      }

      .form-group input,
      .form-group select {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }

      .results-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .results-count {
        font-size: 14px;
        color: #666;
      }

      .results-count strong {
        color: #667eea;
        font-size: 18px;
      }

      .report-card {
        border: 1px solid #e5e5e5;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        transition: all 0.3s;
        cursor: pointer;
        position: relative;
      }

      .report-checkbox {
        position: absolute;
        top: 20px;
        left: 20px;
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .report-card.has-checkbox {
        padding-left: 55px;
      }

      .report-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: #667eea;
      }

      .report-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 15px;
      }

      .report-title {
        flex: 1;
      }

      .report-title h3 {
        color: #333;
        font-size: 18px;
        margin-bottom: 5px;
      }

      .report-meta {
        font-size: 13px;
        color: #666;
      }

      .report-badges {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .badge {
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
      }

      .priority-high {
        background: #fee2e2;
        color: #dc2626;
      }

      .priority-medium {
        background: #fef3c7;
        color: #d97706;
      }

      .priority-low {
        background: #d1fae5;
        color: #059669;
      }

      .tone-angry {
        background: #fecaca;
        color: #991b1b;
      }

      .tone-urgent {
        background: #fed7aa;
        color: #c2410c;
      }

      .tone-frustrated {
        background: #fde68a;
        color: #92400e;
      }

      .tone-confused {
        background: #ddd6fe;
        color: #5b21b6;
      }

      .tone-calm {
        background: #bfdbfe;
        color: #1e40af;
      }

      .category-badge {
        background: #e0e7ff;
        color: #667eea;
      }

      .status-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-new {
        background: #dbeafe;
        color: #1e40af;
      }

      .status-in_progress {
        background: #fef3c7;
        color: #92400e;
      }

      .status-resolved {
        background: #d1fae5;
        color: #065f46;
      }

      .report-description {
        color: #666;
        font-size: 14px;
        line-height: 1.6;
        margin-bottom: 15px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .report-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 15px;
        border-top: 1px solid #f0f0f0;
      }

      .report-stats {
        display: flex;
        gap: 20px;
        font-size: 13px;
        color: #666;
      }

      .report-actions {
        display: flex;
        gap: 10px;
      }

      .btn-small {
        padding: 6px 12px;
        font-size: 12px;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }

      .empty-state svg {
        width: 100px;
        height: 100px;
        margin-bottom: 20px;
        opacity: 0.5;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #667eea;
      }

      .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .skeleton {
        background: linear-gradient(
          90deg,
          #f0f0f0 25%,
          #e0e0e0 50%,
          #f0f0f0 75%
        );
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
      }

      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      .skeleton-card {
        border: 1px solid #e5e5e5;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
      }

      .skeleton-title {
        height: 24px;
        width: 70%;
        border-radius: 4px;
        margin-bottom: 10px;
      }

      .skeleton-text {
        height: 16px;
        width: 100%;
        border-radius: 4px;
        margin-bottom: 8px;
      }

      .skeleton-badge {
        height: 20px;
        width: 80px;
        border-radius: 10px;
        display: inline-block;
        margin-right: 8px;
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }
        .header {
          flex-direction: column;
          gap: 15px;
        }
        .header-actions {
          width: 100%;
          flex-direction: column;
        }
        .search-form {
          grid-template-columns: 1fr;
        }
        .form-group {
          margin-bottom: 15px;
        }
        input,
        select,
        button {
          font-size: 16px;
          min-height: 44px;
        }
      }

      @media (max-width: 768px) {
        .search-form {
          grid-template-columns: 1fr;
        }

        .report-header {
          flex-direction: column;
        }

        .report-footer {
          flex-direction: column;
          gap: 15px;
          align-items: start;
        }
      }
    </style>
  </head>
  <body>
    <button
      class="theme-toggle"
      onclick="toggleTheme()"
      aria-label="Toggle dark mode"
    >
      <span id="themeIcon">üåô</span>
    </button>

    <div class="container">
      <!-- Navigation Header -->
      <nav class="nav-header">
        <a href="/" class="nav-brand"> üéØ INT Triage AI </a>
        <button
          class="nav-toggle"
          onclick="toggleMobileMenu()"
          aria-label="Toggle menu"
        >
          ‚ò∞
        </button>
        <ul class="nav-menu" id="navMenu">
          <li><a href="/" class="nav-link">New Triage</a></li>
          <li>
            <a href="/public/client-history.html" class="nav-link active"
              >History</a
            >
          </li>
          <li>
            <a href="/public/analytics.html" class="nav-link">Analytics</a>
          </li>
          <li><a href="/public/demo.html" class="nav-link">Demo</a></li>
        </ul>
      </nav>

      <div class="header">
        <h1>üìä Client History</h1>
        <div class="header-actions">
          <button
            id="exportSelectedBtn"
            class="btn btn-primary"
            style="display: none"
          >
            Export Selected
          </button>
          <a href="/" class="btn btn-secondary">‚Üê New Triage</a>
          <a href="/demo.html" class="btn btn-secondary">Demo</a>
        </div>
      </div>

      <div
        id="quickStats"
        class="search-section"
        style="
          display: none;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 20px;
          border-radius: 10px;
          margin-bottom: 20px;
        "
      >
        <div
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            text-align: center;
          "
        >
          <div>
            <div style="font-size: 32px; font-weight: 700" id="statTotal">
              -
            </div>
            <div style="font-size: 14px; opacity: 0.9">Total Reports</div>
          </div>
          <div>
            <div style="font-size: 32px; font-weight: 700" id="statNew">-</div>
            <div style="font-size: 14px; opacity: 0.9">New</div>
          </div>
          <div>
            <div style="font-size: 32px; font-weight: 700" id="statProgress">
              -
            </div>
            <div style="font-size: 14px; opacity: 0.9">In Progress</div>
          </div>
          <div>
            <div style="font-size: 32px; font-weight: 700" id="statResolved">
              -
            </div>
            <div style="font-size: 14px; opacity: 0.9">Resolved</div>
          </div>
          <div>
            <div style="font-size: 32px; font-weight: 700" id="statHigh">-</div>
            <div style="font-size: 14px; opacity: 0.9">High Priority</div>
          </div>
        </div>
      </div>

      <div class="search-section">
        <form id="searchForm" class="search-form">
          <div class="form-group">
            <label for="searchQuery"
              >Search Customer / Subject / Description</label
            >
            <input
              type="text"
              id="searchQuery"
              placeholder="Enter customer name, ticket subject, or keywords..."
            />
          </div>
          <div class="form-group">
            <label for="assignedFilter">Assigned To</label>
            <input
              type="text"
              id="assignedFilter"
              placeholder="Filter by CSR name..."
            />
          </div>
          <div class="form-group">
            <label for="priorityFilter">Priority</label>
            <select id="priorityFilter">
              <option value="">All Priorities</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
          </div>
          <div class="form-group">
            <label for="toneFilter">Customer Tone</label>
            <select id="toneFilter">
              <option value="">All Tones</option>
              <option value="angry">Angry</option>
              <option value="urgent">Urgent</option>
              <option value="frustrated">Frustrated</option>
              <option value="confused">Confused</option>
              <option value="calm">Calm</option>
            </select>
          </div>
          <div class="form-group">
            <label for="statusFilter">Status</label>
            <select id="statusFilter">
              <option value="">All Statuses</option>
              <option value="new">New</option>
              <option value="in_progress">In Progress</option>
              <option value="resolved">Resolved</option>
              <option value="escalated">Escalated</option>
              <option value="closed">Closed</option>
            </select>
          </div>
          <div class="form-group">
            <button type="submit" class="btn btn-primary">üîç Search</button>
          </div>
        </form>
      </div>

      <div class="results-section">
        <div class="results-header">
          <div class="results-count">
            <strong id="resultsCount">0</strong> reports found
          </div>
          <button
            id="exportBtn"
            class="btn btn-secondary btn-small"
            style="display: none"
          >
            üì• Export to CSV
          </button>
        </div>

        <div id="resultsContainer">
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>Loading reports...</p>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { initTheme, toggleTheme } from '/public/theme.js';
      import { initKeyboardShortcuts } from '/public/shortcuts.js';
      window.toggleTheme = toggleTheme;
      initTheme();
      initKeyboardShortcuts();
    </script>

    <script type="module">
      import {
        supabase,
        getCustomerReports,
        searchReports,
        getReportById,
      } from '../src/supabaseClient.js';

      // Get URL parameters
      // Mobile menu toggle
      function toggleMobileMenu() {
        const navMenu = document.getElementById('navMenu');
        navMenu.classList.toggle('active');
      }

      const urlParams = new URLSearchParams(window.location.search);
      const customerName = urlParams.get('customer');
      const reportId = urlParams.get('report');

      // Initialize
      document.addEventListener('DOMContentLoaded', async () => {
        if (reportId) {
          await loadSingleReport(reportId);
        } else if (customerName) {
          document.getElementById('searchQuery').value = customerName;
          await loadCustomerReports(customerName);
        } else {
          await loadAllReports();
        }

        // Setup event listeners
        document
          .getElementById('searchForm')
          .addEventListener('submit', handleSearch);
        document
          .getElementById('exportBtn')
          .addEventListener('click', exportToCSV);
      });

      async function loadSingleReport(reportId) {
        const result = await getReportById(reportId);
        if (result.success && result.data) {
          displayReports([result.data]);
        } else {
          showEmpty('Report not found');
        }
      }

      async function loadCustomerReports(customerName) {
        const result = await getCustomerReports(customerName);
        if (result.success) {
          displayReports(result.data);
        } else {
          showError(result.error);
        }
      }

      async function loadAllReports() {
        const result = await searchReports('', {});
        if (result.success) {
          displayReports(result.data);
        } else {
          showError(result.error);
        }
      }

      async function handleSearch(e) {
        e.preventDefault();

        const query = document.getElementById('searchQuery').value;
        const priority = document.getElementById('priorityFilter').value;
        const tone = document.getElementById('toneFilter').value;
        const assigned = document.getElementById('assignedFilter').value;
        const status = document.getElementById('statusFilter').value;

        showLoading();

        const result = await searchReports(query, {
          priority: priority || undefined,
          customerTone: tone || undefined,
          assignedTo: assigned || undefined,
          status: status || undefined,
        });

        if (result.success) {
          displayReports(result.data);
        } else {
          showError(result.error);
        }
      }

      function displayReports(reports) {
        const container = document.getElementById('resultsContainer');
        const countEl = document.getElementById('resultsCount');
        const exportBtn = document.getElementById('exportBtn');

        countEl.textContent = reports.length;

        if (reports.length === 0) {
          showEmpty('No reports found matching your search criteria.');
          exportBtn.style.display = 'none';
          return;
        }

        exportBtn.style.display = 'block';
        updateQuickStats(reports);

        container.innerHTML = reports
          .map(
            (report) => `
                <div class="report-card has-checkbox">
                    <input type="checkbox" class="report-checkbox" value="${report.report_id}" onclick="event.stopPropagation(); toggleSelection();">
                    <div onclick="viewReport('${report.report_id}')">
                    <div class="report-header">
                        <div class="report-title">
                            <h3>${escapeHtml(report.ticket_subject)}</h3>
                            <div class="report-meta">
                                <strong>${escapeHtml(report.customer_name)}</strong> ‚Ä¢
                                ${formatDate(report.created_at)} ‚Ä¢
                                Report ID: ${report.report_id}
                            </div>
                        </div>
                        <div class="report-badges">
                            <span class="status-badge status-${report.status}">${formatStatus(report.status)}</span>
                            <span class="badge priority-${report.priority}">${report.priority.toUpperCase()}</span>
                            <span class="badge tone-${report.customer_tone}">${report.customer_tone}</span>
                            <span class="badge category-badge">${report.category}</span>
                        </div>
                    </div>
                    <div class="report-description">
                        ${escapeHtml(report.issue_description)}
                    </div>
                    <div class="report-footer">
                        <div class="report-stats">
                            <div>üìä Confidence: ${report.confidence_score}%</div>
                            <div>üéØ Department: ${report.metadata?.department || 'N/A'}</div>
                            <div>üë§ Agent: ${report.csr_agent}</div>
                        </div>
                        <div class="report-actions">
                            <button class="btn btn-primary btn-small" onclick="event.stopPropagation(); viewReport('${report.report_id}')">View Details</button>
                            <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); viewCustomerHistory('${escapeHtml(report.customer_name)}')">Customer History</button>
                        </div>
                    </div>
                    </div>
                </div>
            `
          )
          .join('');
      }

      function showLoading() {
        const container = document.getElementById('resultsContainer');
        container.innerHTML = Array(3)
          .fill(0)
          .map(
            () => `
                <div class="skeleton-card">
                    <div class="skeleton skeleton-title"></div>
                    <div class="skeleton skeleton-text" style="width: 90%;"></div>
                    <div class="skeleton skeleton-text" style="width: 60%;"></div>
                    <div style="margin-top: 15px;">
                        <div class="skeleton skeleton-badge"></div>
                        <div class="skeleton skeleton-badge"></div>
                        <div class="skeleton skeleton-badge"></div>
                    </div>
                </div>
            `
          )
          .join('');
      }

      function showEmpty(message) {
        const container = document.getElementById('resultsContainer');
        container.innerHTML = `
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h3>${message}</h3>
                    <p>Try adjusting your search criteria or create a new triage report.</p>
                </div>
            `;
      }

      function showError(error) {
        const container = document.getElementById('resultsContainer');
        container.innerHTML = `
                <div class="empty-state">
                    <h3>Error loading reports</h3>
                    <p>${escapeHtml(error)}</p>
                </div>
            `;
      }

      function viewReport(reportId) {
        window.location.href = `/public/report-detail.html?id=${reportId}`;
      }

      function viewCustomerHistory(customerName) {
        window.location.href = `/client-history.html?customer=${encodeURIComponent(customerName)}`;
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
        });
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function formatStatus(status) {
        const statusMap = {
          new: 'New',
          in_progress: 'In Progress',
          resolved: 'Resolved',
        };
        return statusMap[status] || status;
      }

      function updateQuickStats(reports) {
        document.getElementById('quickStats').style.display = 'block';
        document.getElementById('statTotal').textContent = reports.length;
        document.getElementById('statNew').textContent = reports.filter(
          (r) => r.status === 'new'
        ).length;
        document.getElementById('statProgress').textContent = reports.filter(
          (r) => r.status === 'in_progress'
        ).length;
        document.getElementById('statResolved').textContent = reports.filter(
          (r) => r.status === 'resolved'
        ).length;
        document.getElementById('statHigh').textContent = reports.filter(
          (r) => r.priority === 'high'
        ).length;
      }

      function toggleSelection() {
        const checkboxes = document.querySelectorAll(
          '.report-checkbox:checked'
        );
        const exportBtn = document.getElementById('exportSelectedBtn');
        exportBtn.style.display = checkboxes.length > 0 ? 'block' : 'none';
      }

      document.getElementById('exportSelectedBtn').onclick = async () => {
        const selected = Array.from(
          document.querySelectorAll('.report-checkbox:checked')
        ).map((cb) => cb.value);

        if (selected.length === 0) {
          alert('No reports selected');
          return;
        }

        const { data, error } = await supabase
          .from('reports')
          .select('*')
          .in('report_id', selected);

        if (error) {
          alert(`Error fetching reports: ${error.message}`);
          return;
        }

        exportToCSV(data);
      };

      function exportToCSV(reports) {
        const headers = [
          'Report ID',
          'Customer',
          'Subject',
          'Status',
          'Priority',
          'Tone',
          'Category',
          'Created Date',
        ];
        const rows = reports.map((r) => [
          r.report_id,
          r.customer_name,
          r.ticket_subject,
          r.status || 'new',
          r.priority,
          r.customer_tone,
          r.category,
          new Date(r.created_at).toLocaleString(),
        ]);

        const csvContent = [
          headers.join(','),
          ...rows.map((row) => row.map((cell) => `"${cell}"`).join(',')),
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `reports-export-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      }

      // Make functions global for onclick handlers
      window.viewReport = viewReport;
      window.viewCustomerHistory = viewCustomerHistory;
    </script>
  </body>
</html>
