name: Documentation

on:
  push:
    branches: [master, main]
    paths: ['docs/**', '**.md', '.llms.txt', 'docs/mcp.json']
  pull_request:
    paths: ['docs/**', '**.md', '.llms.txt']
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: docs-pipeline-${{ github.ref }}
  cancel-in-progress: true

env:
  MARKDOWNLINT_VERSION: v16
  YQ_URL: https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64

jobs:
  lint:
    name: Lint Markdown and Links
    runs-on: ubuntu-latest
    outputs:
      lint-status: ${{ steps.lint.outcome }}
    steps:
      - name: Checkout repository (shallow)
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 1

      - name: Run markdownlint (DavidAnson CLI action)
        uses: DavidAnson/markdownlint-cli2-action@v20
        with:
          globs: |
            **/*.md
            !node_modules
            !**/node_modules

      - name: Check for broken links (non-blocking)
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.markdown-link-check.json'
        continue-on-error: true

  validate-llms-txt:
    name: Validate .llms.txt
    runs-on: ubuntu-latest
    outputs:
      llms-status: ${{ steps.validate.outcome }}
    steps:
      - name: Checkout repository (shallow)
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 1

      - name: Validate presence and structure
        id: validate
        run: |
          set -euo pipefail
          if [ ! -f .llms.txt ]; then
            echo "LLMS_MISSING=true" >> $GITHUB_OUTPUT
            echo "::error file=.llms.txt::Missing .llms.txt"
            exit 1
          fi
          grep -q "# FlashFusion Source-of-Truth" .llms.txt || { echo "::error file=.llms.txt::Missing title header"; exit 1; }
          grep -q "## Quick Links" .llms.txt || { echo "::error file=.llms.txt::Missing Quick Links section"; exit 1; }
          grep -q "## Documentation Structure" .llms.txt || { echo "::error file=.llms.txt::Missing Documentation Structure"; exit 1; }
          echo "LLMS_VALID=true" >> $GITHUB_OUTPUT

  validate-mcp:
    name: Validate docs/mcp.json
    runs-on: ubuntu-latest
    outputs:
      mcp-status: ${{ steps.validate.outcome }}
    steps:
      - name: Checkout repository (shallow)
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 1

      - name: Ensure jq present
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Check file exists and is valid JSON
        id: validate
        run: |
          set -euo pipefail
          if [ ! -f docs/mcp.json ]; then
            echo "::error file=docs/mcp.json::Missing docs/mcp.json"
            exit 1
          fi
          if ! jq empty docs/mcp.json 2>/dev/null; then
            echo "::error file=docs/mcp.json::Invalid JSON"
            exit 1
          fi
          echo "MCP_VALID=true" 

  check-staleness:
    name: Check stale documentation (>180 days)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Find stale markdown files
        run: |
          set -euo pipefail
          echo "Looking for docs/*.md older than 180 days"
          find docs/ -name "*.md" -type f -mtime +180 > /tmp/stale.txt || true
          if [ -s /tmp/stale.txt ]; then
            echo "::warning file=docs::Stale documentation found (>180 days)"
            sed -n '1,200p' /tmp/stale.txt
            # Do not fail pipeline; prefers surfaced warnings
          else
            echo "No stale docs detected"
          fi

  validate-progress:
    name: Validate docs/.progress.yaml
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (shallow)
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 1

      - name: Install yq (official binary)
        run: |
          sudo wget -qO /usr/local/bin/yq $YQ_URL
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Validate YAML if present (non-blocking)
        run: |
          set -euo pipefail
          if [ ! -f docs/.progress.yaml ]; then
            echo "::notice file=docs/.progress.yaml::Missing docs/.progress.yaml â€” optional"
            exit 0
          fi
          if ! yq eval . docs/.progress.yaml > /dev/null 2>&1; then
            echo "::error file=docs/.progress.yaml::Invalid YAML"
            exit 1
          fi
          echo "Progress tracker valid"

  check-coverage:
    name: Documentation Coverage Summary
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (shallow)
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 1

      - name: Count documentation files
        run: |
          set -euo pipefail
          echo "Documentation statistics:"
          printf '%-14s %s\n' "Tutorials:" "$(find docs/tutorials -name '*.md' 2>/dev/null | wc -l)"
          printf '%-14s %s\n' "How-Tos:" "$(find docs/how-to -name '*.md' 2>/dev/null | wc -l)"
          printf '%-14s %s\n' "References:" "$(find docs/reference -name '*.md' 2>/dev/null | wc -l)"
          printf '%-14s %s\n' "Explanations:" "$(find docs/explanation -name '*.md' 2>/dev/null | wc -l)"
          printf '%-14s %s\n' "ADRs:" "$(find docs/adr -name '*.md' 2>/dev/null | wc -l)"
          printf '%-14s %s\n' "Runbooks:" "$(find docs/runbooks -name '*.md' 2>/dev/null | wc -l)"
          printf '%-14s %s\n' "Total:" "$(find docs/ -name '*.md' 2>/dev/null | wc -l)"

  summary:
    name: Docs Pipeline Summary
    runs-on: ubuntu-latest
    needs: [lint, validate-llms-txt, validate-mcp, validate-progress, check-coverage, check-staleness]
    if: always()
    steps:
      - name: Print pipeline summary
        run: |
          echo "Documentation pipeline finished for $GITHUB_REF"
          echo ""
          echo "Checks (blocking):"
          echo "- Linting: ${{ needs.lint.result }}"
          echo "- .llms.txt: ${{ needs.validate-llms-txt.result }}"
          echo "- mcp.json: ${{ needs.validate-mcp.result }}"
          echo "- .progress.yaml: ${{ needs.validate-progress.result }}"
          echo ""
          echo "Non-blocking: staleness and link-check warnings may be present in logs"
