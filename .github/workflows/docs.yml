name: Documentation

on:
  push:
    branches: [master, main]
    paths:
      - 'docs/**'
      - '**.md'
      - '.llms.txt'
      - 'docs/mcp.json'
  pull_request:
    paths:
      - 'docs/**'
      - '**.md'
      - '.llms.txt'

permissions:
  contents: read

jobs:
  lint:
    name: Lint Markdown
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v16
        with:
          globs: |
            **/*.md
            !node_modules
            !**/node_modules

      - name: Check for broken links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.markdown-link-check.json'
        continue-on-error: true

  validate-llms-txt:
    name: Validate LLMs.txt
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check .llms.txt exists
        run: |
          if [ ! -f .llms.txt ]; then
            echo "âŒ Missing .llms.txt file"
            exit 1
          fi
          echo "âœ… .llms.txt found"

      - name: Validate .llms.txt format
        run: |
          # Check for required sections
          grep -q "# FlashFusion Source-of-Truth" .llms.txt || (echo "âŒ Missing title" && exit 1)
          grep -q "## Quick Links" .llms.txt || (echo "âŒ Missing Quick Links" && exit 1)
          grep -q "## Documentation Structure" .llms.txt || (echo "âŒ Missing structure" && exit 1)
          echo "âœ… .llms.txt format valid"

  validate-mcp:
    name: Validate MCP Config
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check mcp.json exists
        run: |
          if [ ! -f docs/mcp.json ]; then
            echo "âŒ Missing docs/mcp.json"
            exit 1
          fi
          echo "âœ… docs/mcp.json found"

      - name: Validate JSON syntax
        run: |
          if ! jq empty docs/mcp.json 2>/dev/null; then
            echo "âŒ Invalid JSON in docs/mcp.json"
            exit 1
          fi
          echo "âœ… docs/mcp.json is valid JSON"

  check-staleness:
    name: Check Doc Staleness
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find stale docs (> 6 months)
        run: |
          echo "Checking for stale documentation..."
          find docs/ -name "*.md" -type f -mtime +180 > /tmp/stale.txt || true
          if [ -s /tmp/stale.txt ]; then
            echo "âš ï¸  Stale documentation found (>6 months old):"
            cat /tmp/stale.txt
            echo ""
            echo "Consider reviewing these files for accuracy."
          else
            echo "âœ… No stale documentation found"
          fi
        continue-on-error: true

  validate-progress:
    name: Validate Progress Tracker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Validate .progress.yaml
        run: |
          if [ ! -f docs/.progress.yaml ]; then
            echo "âš ï¸  Missing docs/.progress.yaml (not critical)"
            exit 0
          fi
          if ! yq eval . docs/.progress.yaml > /dev/null 2>&1; then
            echo "âŒ Invalid YAML in docs/.progress.yaml"
            exit 1
          fi
          echo "âœ… docs/.progress.yaml is valid YAML"

  check-coverage:
    name: Check Documentation Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Count documentation files
        run: |
          echo "ðŸ“Š Documentation Statistics:"
          echo "----------------------------"
          echo "Tutorials:    $(find docs/tutorials -name '*.md' 2>/dev/null | wc -l)"
          echo "How-Tos:      $(find docs/how-to -name '*.md' 2>/dev/null | wc -l)"
          echo "References:   $(find docs/reference -name '*.md' 2>/dev/null | wc -l)"
          echo "Explanations: $(find docs/explanation -name '*.md' 2>/dev/null | wc -l)"
          echo "ADRs:         $(find docs/adr -name '*.md' 2>/dev/null | wc -l)"
          echo "Runbooks:     $(find docs/runbooks -name '*.md' 2>/dev/null | wc -l)"
          echo "----------------------------"
          total=$(find docs/ -name '*.md' 2>/dev/null | wc -l)
          echo "Total:        $total"

  summary:
    name: Documentation Summary
    runs-on: ubuntu-latest
    needs: [lint, validate-llms-txt, validate-mcp, validate-progress]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "âœ… Documentation pipeline complete"
          echo ""
          echo "Key validations:"
          echo "- Markdown linting"
          echo "- LLMs.txt format"
          echo "- MCP configuration"
          echo "- Progress tracker"
          echo "- Documentation coverage"
