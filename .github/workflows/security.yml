name: Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 6 * * 1" # Every Monday at 6 AM UTC

permissions:
  contents: read
  security-events: write

jobs:
  gitleaks:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit (all severities)
        id: audit
        run: |
          echo "Running dependency audit..."
          pnpm audit --json > audit-results.json || true
          cat audit-results.json
        continue-on-error: true

      - name: Check for critical/high vulnerabilities
        run: |
          echo "Checking for critical and high severity vulnerabilities..."
          if [ -f audit-results.json ]; then
            # Install jq for JSON parsing
            sudo apt-get update -qq && sudo apt-get install -y -qq jq > /dev/null
            
            # Count vulnerabilities by severity using jq
            CRITICAL=$(jq '[.advisories[]? | select(.severity == "critical")] | length' audit-results.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.advisories[]? | select(.severity == "high")] | length' audit-results.json 2>/dev/null || echo "0")
            
            echo "Critical vulnerabilities: $CRITICAL"
            echo "High vulnerabilities: $HIGH"
            
            if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
              echo "❌ Found critical or high severity vulnerabilities!"
              echo "Please review and update dependencies"
              exit 1
            else
              echo "✅ No critical or high severity vulnerabilities found"
            fi
          else
            echo "⚠️ Audit results file not found, skipping vulnerability check"
          fi

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-audit-results
          path: audit-results.json
          retention-days: 30

  outdated:
    name: Check Outdated Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for outdated dependencies
        run: |
          echo "Checking for outdated dependencies..."
          pnpm outdated || echo "Some dependencies are outdated. Consider updating."
        continue-on-error: true
